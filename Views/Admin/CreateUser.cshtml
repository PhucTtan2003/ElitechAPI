@model Elitech.Controllers.AdminController.CreateUserViewModel

@{
    ViewData["Title"] = "Tạo tài khoản người dùng";
    var hasSuccess = TempData["Success"] != null;
}

<style>
/* ===============================
   CREATE USER – UI POLISH v4 (clean)
   + Confirm Admin modal
   + Generate/Copy password
   + Auto reset after success
   =============================== */

.cu-wrap{margin:0 18px 22px}
.cu-shell{max-width:980px;margin:0 auto}

/* ===== HERO ===== */
.cu-hero{
    display:flex;justify-content:space-between;align-items:center;
    gap:16px;margin:12px 0 18px;flex-wrap:wrap
}
.cu-hero-left{display:flex;gap:14px;align-items:center}
.cu-hero-icon{
    width:54px;height:54px;border-radius:16px;
    display:grid;place-items:center;font-size:26px;color:#111827;
    background:linear-gradient(135deg,#F58220,#E36F15,#1E88E5);
    background-size:200% 200%;
    animation:cu-grad 6s ease infinite;
    box-shadow:0 14px 32px rgba(245,130,32,.45)
}
@@keyframes cu-grad{
    0%{background-position:0% 50%}
    50%{background-position:100% 50%}
    100%{background-position:0% 50%}
}
.cu-hero h1{margin:0 0 2px;font-size:1.35rem;font-weight:900}
.cu-hero p{margin:0;font-size:.9rem;color:#64748b;font-weight:700}

/* ===== CARD ===== */
.cu-card{
    background:linear-gradient(#fff,#fff) padding-box,
               linear-gradient(135deg,rgba(245,130,32,.6),rgba(30,136,229,.45)) border-box;
    border:2px solid transparent;border-radius:18px;
    box-shadow:0 16px 38px rgba(15,23,42,.14);overflow:hidden
}
.cu-head{
    padding:14px 16px;border-bottom:1px dashed #e5e7eb;
    display:flex;justify-content:space-between;gap:10px;align-items:baseline
}
.cu-head h5{margin:0;font-size:1rem;font-weight:900;display:flex;align-items:center;gap:8px}
.cu-sub{font-size:.82rem;color:#64748b;font-weight:800}
.cu-body{padding:16px}

/* ===== ALERT ===== */
.cu-alert{
    display:flex;gap:12px;padding:12px;border-radius:14px;margin-bottom:14px;
    align-items:flex-start;border:1px solid #e5e7eb;background:#f8fafc
}
.cu-alert.ok{background:#ecfdf5;border-color:#bbf7d0}
.cu-alert.err{background:#fff1f2;border-color:#fecaca}
.cu-alert .ico{
    width:34px;height:34px;border-radius:12px;display:grid;place-items:center;
    background:#fff;box-shadow:0 10px 22px rgba(15,23,42,.1)
}
.cu-alert.ok .ico{color:#059669}
.cu-alert.err .ico{color:#b91c1c}
.cu-alert b{display:block;font-weight:900}
.cu-alert .msg{font-size:.85rem;font-weight:700;color:#334155;line-height:1.25rem}

/* ===== FORM ===== */
.cu-label{font-weight:900;font-size:.85rem;margin-bottom:6px;display:flex;align-items:center;gap:8px}
.cu-label i{color:#f97316}
.cu-help{font-size:.8rem;color:#64748b;margin-top:6px;line-height:1.25rem}

/* Strength / role pill */
.cu-pill{
    margin-top:8px;display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:999px;font-size:.8rem;font-weight:900;
    border:1px solid #e5e7eb;background:#fff;box-shadow:0 10px 22px rgba(15,23,42,.1)
}
.cu-pill .dot{width:10px;height:10px;border-radius:50%}
.cu-pill.ok .dot{background:#10B981}
.cu-pill.warn .dot{background:#F59E0B}
.cu-pill.bad .dot{background:#EF4444}

/* Actions */
.cu-actions{margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}

/* Password row tools */
.cu-inline-tools{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
.cu-mini{
    padding:8px 10px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;
    font-weight:900;font-size:.82rem;display:inline-flex;gap:8px;align-items:center;
    box-shadow:0 10px 22px rgba(15,23,42,.10);cursor:pointer;
    transition: transform .12s ease;
}
.cu-mini:hover{transform:translateY(-1px)}
.cu-mini:active{transform:scale(.98)}
.cu-mini.brand{
    border:0;
    background:linear-gradient(180deg,#F58220,#E36F15);
    color:#111827;
    box-shadow:0 12px 26px rgba(245,130,32,.28)
}
.cu-mini.blue{
    border-color:rgba(30,136,229,.35);
    background:linear-gradient(180deg,#e0edff,#f8fbff);
    color:#1e40af;
}
.cu-mini:disabled{opacity:.65;cursor:not-allowed;transform:none}

/* Copy hint */
.cu-hintline{font-size:.8rem;color:#64748b;font-weight:800;margin-top:8px}
.cu-hint-ok{color:#059669;font-weight:900}
.cu-hint-warn{color:#b45309;font-weight:900}
.cu-hint-err{color:#b91c1c;font-weight:900}

/* Modal polish */
.cu-modal-head{display:flex;gap:10px;align-items:center}
.cu-modal-ico{
    width:38px;height:38px;border-radius:14px;display:grid;place-items:center;
    background:#fff7ed;border:1px solid #fed7aa;color:#b45309
}

/* Loading spin */
@@keyframes cu-spin{to{transform:rotate(360deg)}}
.cu-spin{display:inline-block;animation:cu-spin 1s linear infinite}

/* ===== Back to Admin button – POLISHED (nhẹ) ===== */
.sx-btn.back-admin{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:9px 14px;
    border-radius:999px;
    font-size:.82rem;
    font-weight:900;
    letter-spacing:.02em;
    color:#1e3a8a;
    background:linear-gradient(180deg,#eef6ff,#ffffff);
    border:1px solid rgba(30,136,229,.35);
    box-shadow:0 10px 26px rgba(30,136,229,.18), inset 0 0 0 1px rgba(255,255,255,.7);
    text-decoration:none;
    cursor:pointer;
    transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
}
.sx-btn.back-admin i{font-size:1rem;transition:transform .15s ease}
.sx-btn.back-admin:hover{
    background:linear-gradient(180deg,#dbeafe,#f8fbff);
    transform:translateY(-1px);
    box-shadow:0 14px 34px rgba(30,136,229,.28), inset 0 0 0 1px rgba(255,255,255,.8);
}
.sx-btn.back-admin:hover i{transform:translateX(-2px)}
.sx-btn.back-admin:active{transform:scale(.96)}

/* Mobile */
@@media(max-width:576px){
    .cu-wrap{margin:0 12px 18px}
    .cu-body{padding:12px}
    .sx-btn.back-admin{padding:8px 12px;font-size:.78rem}
}
</style>

<div class="elx-dashboard">
    <div class="cu-wrap">
        <div class="cu-shell">

            <!-- ===== HERO ===== -->
            <div class="cu-hero">
                <div class="cu-hero-left">
                    <div class="cu-hero-icon"><i class="bi bi-person-plus"></i></div>
                    <div>
                        <h1>Tạo tài khoản người dùng</h1>
                        <p>Admin tạo user mới • phân quyền • mật khẩu hash an toàn</p>
                    </div>
                </div>

                <a asp-controller="Admin" asp-action="Index" class="sx-btn back-admin">
                    <i class="bi bi-arrow-left"></i>
                    <span>Về Admin</span>
                </a>
            </div>

            <!-- ===== CARD ===== -->
            <div class="cu-card">
                <div class="cu-head">
                    <h5><i class="bi bi-person-badge"></i> Thông tin tài khoản</h5>
                    <span class="cu-sub">MongoDB • BCrypt • Role-based</span>
                </div>

                <div class="cu-body">

                    @if (hasSuccess)
                    {
                        <div class="cu-alert ok">
                            <div class="ico"><i class="bi bi-check-circle"></i></div>
                            <div>
                                <b>Tạo tài khoản thành công</b>
                                <div class="msg">@TempData["Success"]</div>
                            </div>
                        </div>
                    }

                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="cu-alert err">
                            <div class="ico"><i class="bi bi-exclamation-triangle"></i></div>
                            <div style="width:100%">
                                <b>Dữ liệu chưa hợp lệ</b>
                                <div class="msg">Vui lòng kiểm tra lại:</div>
                                <ul style="margin:8px 0 0;padding-left:18px">
                                    @foreach (var err in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                                    {
                                        <li style="color:#b91c1c;font-weight:900;font-size:.85rem">@err.ErrorMessage</li>
                                    }
                                </ul>
                            </div>
                        </div>
                    }

                    <form asp-action="CreateUser" method="post" id="createUserForm" autocomplete="off">
                        @Html.AntiForgeryToken()

                        <div class="elx-form-grid">

                            <!-- Username -->
                            <div class="elx-col-6">
                                <div class="cu-label"><i class="bi bi-person"></i> Username</div>
                                <input asp-for="Username" class="elx-input" placeholder="vd: user_kho_a" id="username" />
                                <div class="cu-help">Không dấu, không khoảng trắng, duy nhất</div>
                            </div>

                            <!-- Password -->
                            <div class="elx-col-6">
                                <div class="cu-label"><i class="bi bi-key"></i> Password</div>
                                <input asp-for="Password" type="password" class="elx-input" id="pwd" placeholder="••••••••" />
                                <div class="cu-help">Password được hash bằng BCrypt (không lưu plain text)</div>

                                <div class="cu-pill bad" id="pwdStrength" aria-live="polite">
                                    <span class="dot"></span>
                                    <span id="pwdStrengthText">Độ mạnh: yếu</span>
                                </div>

                                <div class="cu-inline-tools">
                                    <button type="button" class="cu-mini brand" id="btnGenPwd">
                                        <i class="bi bi-magic"></i> Tạo mật khẩu
                                    </button>
                                    <button type="button" class="cu-mini blue" id="btnCopyPwd">
                                        <i class="bi bi-clipboard"></i> Copy mật khẩu
                                    </button>
                                    <button type="button" class="cu-mini" id="btnTogglePwd">
                                        <i class="bi bi-eye"></i> Hiện/Ẩn
                                    </button>
                                </div>

                                <div class="cu-hintline" id="pwdHint">
                                    Tip: Bấm “Tạo mật khẩu” để auto password mạnh, rồi copy gửi cho user.
                                </div>
                            </div>

                            <!-- Role -->
                            <div class="elx-col-6">
                                <div class="cu-label"><i class="bi bi-shield-check"></i> Role</div>
                                <select asp-for="Role" class="elx-input" id="roleSel">
                                    <option value="User">User</option>
                                    <option value="Admin">Admin</option>
                                </select>
                                <div class="cu-help">User: quyền hạn giới hạn • Admin: toàn quyền</div>

                                <div class="cu-pill warn" id="rolePreview" aria-live="polite">
                                    <span class="dot"></span>
                                    <span id="rolePreviewText">Role: User</span>
                                </div>
                            </div>

                            <!-- Security note -->
                            <div class="elx-col-12">
                                <div style="border-radius:14px;padding:12px;background:linear-gradient(180deg,#f8fafc,#fff);border:1px dashed rgba(245,130,32,.45)">
                                    <div style="font-weight:900;margin-bottom:6px;display:flex;align-items:center;gap:8px">
                                        <i class="bi bi-info-circle" style="color:#f97316"></i> Gợi ý bảo mật
                                    </div>
                                    <div style="color:#334155;font-weight:800;font-size:.85rem;line-height:1.35rem">
                                        • Password hash bằng <b>BCrypt</b><br/>
                                        • Không lưu thông tin nhạy cảm ở frontend<br/>
                                        • Nên dùng mật khẩu dài ≥ 12 ký tự, có chữ hoa + số + ký tự đặc biệt
                                    </div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="elx-col-12">
                                <div class="cu-actions">
                                    <button type="submit" class="elx-btn primary" id="btnSubmit">
                                        <i class="bi bi-person-check"></i> Tạo tài khoản
                                    </button>

                                    <span class="cu-help" style="margin:0">
                                        Nếu Role = <b>Admin</b> sẽ yêu cầu xác nhận.
                                    </span>
                                </div>
                            </div>

                        </div>
                    </form>

                </div>
            </div>

        </div>
    </div>
</div>

<!-- ===== Admin Confirm Modal (Bootstrap) ===== -->
<div class="modal fade" id="adminConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius:16px;overflow:hidden;border:1px solid #e5e7eb">
            <div class="modal-header" style="background:linear-gradient(180deg,#fff7ed,#fff);border-bottom:1px solid #e5e7eb">
                <div class="cu-modal-head">
                    <div class="cu-modal-ico"><i class="bi bi-shield-exclamation"></i></div>
                    <div>
                        <div style="font-weight:900">Xác nhận tạo Admin</div>
                        <div style="font-size:.85rem;color:#64748b;font-weight:800">Admin có toàn quyền hệ thống</div>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body" style="padding:14px 16px">
                <div style="font-weight:900;margin-bottom:6px">Bạn chắc chắn muốn tạo tài khoản với Role = Admin?</div>
                <div style="color:#334155;font-weight:800;font-size:.9rem;line-height:1.35rem">
                    • Username: <span class="mono" id="mUsername">—</span><br />
                    • Role: <b>Admin</b><br />
                    • Lưu ý: chỉ cấp quyền Admin khi thật sự cần.
                </div>
            </div>

            <div class="modal-footer" style="border-top:1px solid #e5e7eb;padding:12px 16px">
                <button type="button" class="cu-mini" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Huỷ
                </button>
                <button type="button" class="cu-mini brand" id="btnConfirmAdmin">
                    <i class="bi bi-check2-circle"></i> OK, tạo Admin
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts{
<script>
(function () {
    const form = document.getElementById('createUserForm');
    const btnSubmit = document.getElementById('btnSubmit');
    const username = document.getElementById('username');
    const pwd = document.getElementById('pwd');
    const roleSel = document.getElementById('roleSel');

    const pwdStrength = document.getElementById('pwdStrength');
    const pwdStrengthText = document.getElementById('pwdStrengthText');

    const rolePreview = document.getElementById('rolePreview');
    const rolePreviewText = document.getElementById('rolePreviewText');

    const btnGenPwd = document.getElementById('btnGenPwd');
    const btnCopyPwd = document.getElementById('btnCopyPwd');
    const btnTogglePwd = document.getElementById('btnTogglePwd');
    const pwdHint = document.getElementById('pwdHint');

    // ===== Password strength =====
    function score(p) {
        if (!p) return 0;
        let s = 0;
        if (p.length >= 8) s++;
        if (p.length >= 12) s++;
        if (/[A-Z]/.test(p)) s++;
        if (/[a-z]/.test(p)) s++;
        if (/[0-9]/.test(p)) s++;
        if (/[^A-Za-z0-9]/.test(p)) s++;
        return s;
    }
    function renderStrength() {
        if (!pwdStrength || !pwdStrengthText) return;
        const s = score(pwd?.value || "");
        pwdStrength.classList.remove('ok', 'warn', 'bad');
        if (s >= 5) {
            pwdStrength.classList.add('ok');
            pwdStrengthText.textContent = 'Độ mạnh: mạnh';
        } else if (s >= 3) {
            pwdStrength.classList.add('warn');
            pwdStrengthText.textContent = 'Độ mạnh: trung bình';
        } else {
            pwdStrength.classList.add('bad');
            pwdStrengthText.textContent = 'Độ mạnh: yếu';
        }
    }
    pwd?.addEventListener('input', renderStrength);
    renderStrength();

    // ===== Role preview =====
    function renderRole() {
        if (!rolePreview || !rolePreviewText || !roleSel) return;
        rolePreview.classList.remove('ok', 'warn', 'bad');
        if (roleSel.value === 'Admin') {
            rolePreview.classList.add('ok');
            rolePreviewText.textContent = 'Role: Admin (toàn quyền)';
        } else {
            rolePreview.classList.add('warn');
            rolePreviewText.textContent = 'Role: User (giới hạn)';
        }
    }
    roleSel?.addEventListener('change', renderRole);
    renderRole();

    // ===== Generate password =====
    function genPassword(len = 14) {
        // mix: lower/upper/num/special
        const lower = "abcdefghijkmnpqrstuvwxyz";
        const upper = "ABCDEFGHJKLMNPQRSTUVWXYZ";
        const num = "23456789";
        const special = "!@@#$%^&*_-+=?"; // ✅ fix double "@@"
        const all = lower + upper + num + special;

        const pick = (s) => s[Math.floor(Math.random() * s.length)];
        let out = [pick(lower), pick(upper), pick(num), pick(special)];
        for (let i = out.length; i < len; i++) out.push(pick(all));

        for (let i = out.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [out[i], out[j]] = [out[j], out[i]];
        }
        return out.join("");
    }

    btnGenPwd?.addEventListener('click', () => {
        if (!pwd) return;
        pwd.value = genPassword(14);
        pwd.type = "text"; // show once for convenience
        renderStrength();
        if (pwdHint) pwdHint.innerHTML = `<span class="cu-hint-ok">Đã tạo password mạnh.</span> Bấm “Copy mật khẩu” để gửi cho user.`;
        pwd.focus();
        setTimeout(() => { pwd.type = "password"; }, 2000);
    });

    // ===== Copy password =====
    btnCopyPwd?.addEventListener('click', async () => {
        const val = (pwd?.value || "").trim();
        if (!val) {
            if (pwdHint) pwdHint.innerHTML = `<span class="cu-hint-warn">Chưa có password.</span> Hãy nhập hoặc bấm “Tạo mật khẩu”.`;
            pwd?.focus();
            return;
        }
        try {
            await navigator.clipboard.writeText(val);
            if (pwdHint) pwdHint.innerHTML = `<span class="cu-hint-ok">Đã copy password.</span> Bạn có thể dán gửi cho user.`;
        } catch {
            try {
                pwd.type = "text";
                pwd.select();
                document.execCommand("copy");
                if (pwdHint) pwdHint.innerHTML = `<span class="cu-hint-ok">Đã copy password.</span>`;
                setTimeout(() => { pwd.type = "password"; }, 1200);
            } catch {
                if (pwdHint) pwdHint.innerHTML = `<span class="cu-hint-err">Copy thất bại.</span> Trình duyệt chặn clipboard.`;
            }
        }
    });

    // ===== Toggle show/hide =====
    btnTogglePwd?.addEventListener('click', () => {
        if (!pwd) return;
        pwd.type = (pwd.type === "password") ? "text" : "password";
    });

    // ===== Confirm Admin modal before submit =====
    let adminConfirmed = false;

    const modalEl = document.getElementById('adminConfirmModal');
    const mUsername = document.getElementById('mUsername');
    const btnConfirmAdmin = document.getElementById('btnConfirmAdmin');

    let bsModal = null;
    if (modalEl && window.bootstrap?.Modal) {
        bsModal = new bootstrap.Modal(modalEl);
    }

    form?.addEventListener('submit', (e) => {
        if (btnSubmit?.disabled) return;

        const role = roleSel?.value || "User";
        if (role === "Admin" && !adminConfirmed) {
            e.preventDefault();
            if (mUsername) mUsername.textContent = (username?.value || "—").trim() || "—";

            if (bsModal) {
                bsModal.show();
            } else {
                const ok = confirm("Bạn chắc chắn muốn tạo tài khoản Admin?");
                if (ok) {
                    adminConfirmed = true;
                    form.submit();
                }
            }
            return;
        }

        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<i class="bi bi-arrow-repeat cu-spin"></i> Đang tạo...';
    });

    btnConfirmAdmin?.addEventListener('click', () => {
        adminConfirmed = true;
        bsModal?.hide();
        form?.requestSubmit ? form.requestSubmit() : form.submit();
    });

    roleSel?.addEventListener('change', () => { adminConfirmed = false; });

    // ===== Auto reset after success =====
    const hasSuccess = @((hasSuccess ? "true" : "false"));
    if (hasSuccess) {
        setTimeout(() => {
            if (username) username.value = "";
            if (pwd) { pwd.value = ""; pwd.type = "password"; }
            if (roleSel) roleSel.value = "User";
            renderStrength();
            renderRole();
            adminConfirmed = false;
            if (pwdHint) pwdHint.textContent = "Tip: Bấm “Tạo mật khẩu” để auto password mạnh, rồi copy gửi cho user.";
            username?.focus();
        }, 150);
    }
})();
</script>
}

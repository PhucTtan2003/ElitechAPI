@{
    ViewData["Title"] = "Set Param";
    Layout = "_Layout";
}

<style>
    :root {
        /* ===== Light Elitech Admin (indigo/teal, clean, no darkmode) ===== */
        --bg: #f5f7fb;
        --bg2: #eef2ff;
        --card: #ffffff;
        --card2: rgba(255,255,255,.78);
        --stroke: rgba(15,23,42,.10);
        --stroke2: rgba(15,23,42,.08);
        --ink: #0f172a;
        --mut: #64748b;
        --brand: #4f46e5; /* indigo */
        --brand2: #7c3aed; /* violet */
        --accent: #14b8a6; /* teal */

        --ok: #16a34a;
        --err: #ef4444;
        --warn: #f59e0b;
        --shadow: 0 18px 45px rgba(2,8,23,.08);
        --shadow2: 0 10px 22px rgba(2,8,23,.06);
        --radius: 18px;
        --radius2: 14px;
    }

    body {
        color: var(--ink);
        background: radial-gradient(1200px 680px at 100% -20%, rgba(79,70,229,.14), transparent 55%), radial-gradient(900px 520px at 0% 0%, rgba(20,184,166,.12), transparent 55%), linear-gradient(180deg, #ffffff 0%, var(--bg) 60%, #ffffff 100%);
        min-height: 100vh;
    }

    .sp-wrap {
        max-width: 1060px;
        margin: 0 auto;
        padding: 18px 14px 28px;
    }

    .sp-shell {
        border-radius: 22px;
        border: 1px solid var(--stroke2);
        background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.82));
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    .sp-top {
        padding: 18px 18px 14px;
        border-bottom: 1px solid var(--stroke2);
        background: radial-gradient(980px 260px at 25% 0%, rgba(79,70,229,.16), transparent 55%), radial-gradient(860px 240px at 85% 0%, rgba(20,184,166,.12), transparent 55%), rgba(255,255,255,.82);
        backdrop-filter: blur(10px);
    }

    .sp-topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
    }

    /* ===== Back button (override Bootstrap reboot a{}) ===== */
    .sp-shell a.sp-back,
    .sp-shell a.sp-back:visited,
    .sp-shell a.sp-back:hover,
    .sp-shell a.sp-back:active {
        display: inline-flex !important;
        align-items: center !important;
        gap: 8px !important;
        padding: 10px 14px !important;
        border-radius: 14px !important;
        font-weight: 950 !important;
        text-decoration: none !important;
        color: rgba(15,23,42,.78) !important;
        border: 1px solid rgba(15,23,42,.12) !important;
        background: rgba(255,255,255,.92) !important;
        box-shadow: 0 10px 18px rgba(2,8,23,.06) !important;
        transition: transform .12s ease, filter .12s ease !important;
    }

        .sp-shell a.sp-back:hover {
            filter: brightness(1.03) !important;
            transform: translateY(-1px) !important;
        }

        .sp-shell a.sp-back:active {
            transform: translateY(0) !important;
            filter: brightness(.98) !important;
        }

    .sp-badge {
        font-size: 11px;
        font-weight: 900;
        padding: 5px 10px;
        border-radius: 999px;
        color: #1f2a44;
        border: 1px solid rgba(79,70,229,.18);
        background: rgba(79,70,229,.08);
        white-space: nowrap;
    }

    .sp-title {
        margin: 0;
        font-weight: 950;
        letter-spacing: .2px;
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .sp-sub {
        margin-top: 8px;
        color: var(--mut);
        font-size: 13px;
        line-height: 1.45;
    }

    .sp-body {
        padding: 16px 18px 18px;
    }

    .sp-grid {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 14px;
        align-items: start;
    }

    .sp-card {
        border: 1px solid var(--stroke2);
        background: var(--card2);
        border-radius: var(--radius);
        padding: 12px;
        box-shadow: var(--shadow2);
    }

    .sp-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .sp-row4 {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-top: 12px;
    }

    .sp-fieldhead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
    }

    label {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        font-weight: 900;
        color: rgba(15,23,42,.80);
        letter-spacing: .2px;
        margin: 0 0 6px;
    }

    .sp-help {
        font-size: 12px;
        color: var(--mut);
        white-space: nowrap;
    }

    .sp-field input {
        width: 100%;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid rgba(15,23,42,.12);
        background: #fff;
        color: var(--ink);
        font-size: 14px;
        outline: none;
        box-shadow: inset 0 1px 0 rgba(2,8,23,.04);
    }

        .sp-field input:focus {
            border-color: rgba(79,70,229,.55);
            box-shadow: 0 0 0 4px rgba(79,70,229,.14);
        }

    .sp-note {
        margin-top: 12px;
        color: var(--mut);
        font-size: 12px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        padding: 0 2px;
    }

    .sp-notechip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 1px solid rgba(15,23,42,.10);
        background: rgba(255,255,255,.9);
        border-radius: 999px;
        padding: 6px 10px;
        font-weight: 900;
        color: rgba(15,23,42,.78);
    }

    .sp-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 14px;
        flex-wrap: wrap;
    }

    .sp-btn {
        border: none;
        border-radius: 14px;
        padding: 11px 16px;
        font-weight: 950;
        color: #fff;
        background: radial-gradient(140px 60px at 20% 10%, rgba(255,255,255,.30), transparent 60%), linear-gradient(180deg, rgba(79,70,229,1), rgba(124,58,237,1));
        box-shadow: 0 14px 28px rgba(79,70,229,.22);
        cursor: pointer;
        transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }

        .sp-btn:hover {
            filter: brightness(1.03);
            transform: translateY(-1px);
        }

        .sp-btn:active {
            transform: translateY(0);
            filter: brightness(.98);
        }

        .sp-btn:disabled {
            opacity: .6;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

    .sp-status {
        font-size: 12px;
        font-weight: 950;
        padding: 7px 10px;
        border-radius: 999px;
        border: 1px solid rgba(15,23,42,.12);
        background: rgba(255,255,255,.92);
        color: rgba(15,23,42,.68);
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

        .sp-status.ok {
            color: var(--ok);
            border-color: rgba(22,163,74,.20);
            background: rgba(22,163,74,.08);
        }

        .sp-status.err {
            color: var(--err);
            border-color: rgba(239,68,68,.20);
            background: rgba(239,68,68,.08);
        }

        .sp-status.warn {
            color: var(--warn);
            border-color: rgba(245,158,11,.24);
            background: rgba(245,158,11,.10);
        }

    .sp-out {
        margin-top: 14px;
        border-radius: var(--radius);
        border: 1px solid rgba(15,23,42,.10);
        background: #fff;
        overflow: hidden;
        box-shadow: var(--shadow2);
    }

    .sp-outhead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 12px;
        border-bottom: 1px solid rgba(15,23,42,.08);
        color: rgba(15,23,42,.72);
        font-size: 12px;
        font-weight: 950;
        background: radial-gradient(700px 220px at 20% 0%, rgba(20,184,166,.10), transparent 55%), rgba(255,255,255,.92);
    }

    .sp-copy {
        border: 1px solid rgba(15,23,42,.10);
        background: rgba(255,255,255,.95);
        color: rgba(15,23,42,.78);
        border-radius: 10px;
        padding: 6px 10px;
        cursor: pointer;
        font-weight: 950;
        font-size: 12px;
    }

        .sp-copy:hover {
            filter: brightness(1.03);
        }

    pre {
        margin: 0;
        padding: 12px;
        color: #0b1220;
        font-size: 12px;
        overflow: auto;
        min-height: 84px;
        line-height: 1.45;
        background: #fbfdff;
    }

    .ico {
        width: 16px;
        height: 16px;
        opacity: .9;
        flex: 0 0 auto;
    }

    @@media (max-width: 1024px) {
        .sp-row4 {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 900px) {
        .sp-grid {
            grid-template-columns: 1fr;
        }
    }

    @@media (max-width: 520px) {
        .sp-wrap {
            padding: 14px 12px 22px;
        }

        .sp-top {
            padding: 16px 14px 12px;
        }

        .sp-body {
            padding: 14px;
        }

        .sp-topbar {
            flex-direction: column;
            align-items: stretch;
        }

        .sp-badge {
            align-self: flex-end;
        }

        .sp-row {
            grid-template-columns: 1fr;
        }

        .sp-row4 {
            grid-template-columns: 1fr;
        }

        .sp-actions {
            flex-direction: column;
            align-items: stretch;
        }

        .sp-btn {
            width: 100%;
            justify-content: center;
            padding: 13px 16px;
        }

        .sp-status {
            justify-content: center;
        }

        pre {
            font-size: 11px;
        }
    }
</style>

<div class="sp-wrap">
    <div class="sp-shell">
        <div class="sp-top">
            <div class="sp-topbar">
                <a asp-controller="Admin" asp-action="Index" class="sp-back">← Về Admin</a>
                <span class="sp-badge">Admin Tool</span>
            </div>

            <h1 class="sp-title">
                <svg class="ico" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 6.5C4 5.12 5.12 4 6.5 4h11C19.88 4 21 5.12 21 6.5v11c0 1.38-1.12 2.5-2.5 2.5h-11C5.12 20 4 18.88 4 17.5v-11Z" stroke="currentColor" stroke-width="1.6" />
                    <path d="M7 8h10M7 12h10M7 16h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                </svg>
                Elitech API #5 — SetParam
                <span class="sp-badge">Admin Tool</span>
            </h1>

            <div class="sp-sub">
                Cấu hình <b>record/upload interval</b>, và ngưỡng <b>nhiệt/ẩm</b> cho thiết bị.
            </div>
        </div>

        <div class="sp-body">
            <div class="sp-grid">
                <!-- LEFT: Device GUID -->
                <div class="sp-card">
                    <div class="sp-field">
                        <label>Device GUID</label>
                        <input id="deviceGuid"
                               value="@ViewBag.DeviceGuid"
                               placeholder="90319774496194524687"
                               autocomplete="off" />
                    </div>

                    <div class="sp-note">
                        <span class="sp-notechip">Gợi ý mặc định: <b>15–30°C</b></span>
                        <span class="sp-notechip">Độ ẩm: <b>50–75% RH</b></span>
                    </div>
                </div>

                <!-- RIGHT: intervals -->
                <div class="sp-card">
                    <div class="sp-fieldhead">
                        <label>Intervals</label>
                        <span class="sp-help">seconds</span>
                    </div>

                    <div class="sp-row">
                        <div class="sp-field">
                            <label>Thời gian ghi</label>
                            <input id="recordInterval" type="number" inputmode="numeric" value="30" />
                        </div>

                        <div class="sp-field">
                            <label>Thời gian tải lên</label>
                            <input id="uploadInterval" type="number" inputmode="numeric" value="30" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- thresholds -->
            <div class="sp-card" style="margin-top:14px;">
                <div class="sp-fieldhead">
                    <label>Thresholds</label>
                    <span class="sp-help">°C / %RH</span>
                </div>

                <div class="sp-row4">
                    <div class="sp-field">
                        <label>Ngưỡng nhiệt độ trên</label>
                        <input id="tmpUpper" inputmode="decimal" value="30" />
                    </div>

                    <div class="sp-field">
                        <label>Ngưỡng nhiệt độ dưới</label>
                        <input id="tmpLower" inputmode="decimal" value="15" />
                    </div>

                    <div class="sp-field">
                        <label>Ngưỡng độ ẩm trên</label>
                        <input id="humUpper" inputmode="decimal" value="75" />
                    </div>

                    <div class="sp-field">
                        <label>Ngưỡng độ ẩm dưới</label>
                        <input id="humLower" inputmode="decimal" value="50" />
                    </div>
                </div>

                <div class="sp-actions">
                    <button class="sp-btn" id="btn" type="button">
                        <svg class="ico" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2l3 7h7l-5.7 4.1L18 21l-6-4-6 4 1.7-7.9L2 9h7l3-7Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round" />
                        </svg>
                        Submit
                    </button>
                    <span id="status" class="sp-status">Chưa chạy</span>
                </div>
            </div>

            <div class="sp-out">
                <div class="sp-outhead">
                    <span>Response</span>
                    <button type="button" class="sp-copy" id="copyBtn">Copy</button>
                </div>
                <pre id="out">{}</pre>
            </div>
        </div>
    </div>
</div>

<script>
    const $ = (id) => document.getElementById(id);

    function readNum(id){
        const el = $(id);
        if (!el) return null;
        const v = (el.value || "").trim();
        if (!v) return null;
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
    }

    function readStr(id){
        const el = $(id);
        if (!el) return null;
        const v = (el.value || "").trim();
        return v ? v : null;
    }

    function setStatus(text, kind){
        const s = $("status");
        s.textContent = text || "";
        s.className = "sp-status" + (kind ? (" " + kind) : "");
    }

    function validateThresholds(){
        const tL = readNum("tmpLower");
        const tU = readNum("tmpUpper");
        if (tL !== null && tU !== null && tL >= tU) return "Nhiệt độ dưới phải nhỏ hơn nhiệt độ trên.";

        const hL = readNum("humLower");
        const hU = readNum("humUpper");
        if (hL !== null && hU !== null && hL >= hU) return "Độ ẩm dưới phải nhỏ hơn độ ẩm trên.";

        return null;
    }

    $("copyBtn").addEventListener("click", async () => {
        const text = $("out").textContent || "";
        try{
            await navigator.clipboard.writeText(text);
            setStatus("Đã copy response", "ok");
            setTimeout(()=> setStatus("Chưa chạy", ""), 1200);
        }catch{
            setStatus("Copy thất bại", "err");
            setTimeout(()=> setStatus("Chưa chạy", ""), 1200);
        }
    });

    $("btn").addEventListener("click", async () => {
        const deviceGuid = readStr("deviceGuid");
        if (!deviceGuid) { setStatus("Thiếu Device GUID", "err"); return; }

        const err = validateThresholds();
        if (err) { setStatus(err, "err"); return; }

        $("btn").disabled = true;
        setStatus("Đang gửi...", "warn");
        $("out").textContent = "{}";

        const payload = {
            deviceGuid: deviceGuid,
            recordInterval: readNum("recordInterval"),
            uploadInterval: readNum("uploadInterval"),
            tmpUpper: readStr("tmpUpper"),
            tmpLower: readStr("tmpLower"),
            humUpper: readStr("humUpper"),
            humLower: readStr("humLower"),
        };

        try{
            const r = await fetch("/api/elitech/set-param", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(payload)
            });

            const j = await r.json().catch(() => ({}));
            $("out").textContent = JSON.stringify(j, null, 2);

            if (r.ok && j && typeof j === "object" && "code" in j && j.code === 0){
                setStatus("OK", "ok");
            } else {
                setStatus(r.ok ? "Upstream lỗi (code != 0)" : ("HTTP " + r.status), "err");
            }
        }catch(e){
            $("out").textContent = JSON.stringify({ error: String(e) }, null, 2);
            setStatus("Error", "err");
        }finally{
            $("btn").disabled = false;
        }
    });
</script>

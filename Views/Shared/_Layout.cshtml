@* Views/Shared/_Layout.cshtml *@
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@(string.IsNullOrWhiteSpace(ViewData["Title"]?.ToString()) ? "Elitech" : $"{ViewData["Title"]} - Elitech")</title>

    <link rel="icon" type="image/png" href="~/Pictures/logoelitech.png" />
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/Elitech.styles.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/app/asset-admin.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --elx-orange: #F58220;
            --elx-orange-600: #e36f15;
            --elx-navy: #0D47A1;
            --elx-navy-700: #12326f;
            --elx-navy-800: #0F2E6E;
            --elx-navy-900: #0A1322;
            --elx-bg: #F3F6FB;
            --elx-text: #0e1320;
            --elx-muted: #6b7280;
            --elx-card: rgba(255,255,255,0.86);
            --elx-border: rgba(226,232,240,0.90);
            --elx-radius: 14px;
            --elx-shadow-soft: 0 18px 45px rgba(15,35,78,0.18);
            --elx-stroke-soft: rgba(255,255,255,0.14);
            --elx-muted-footer: #9aa6bf;
            --elx-stroke: rgba(255,255,255,.08);
            /* UI-only tokens */
            --elx-radius-xl: 18px;
            --elx-shadow-lg: 0 22px 55px rgba(9,20,48,.22);
            --elx-glass: rgba(255,255,255,.72);
            --elx-glass-2: rgba(255,255,255,.86);
            --elx-focus: rgba(59,130,246,.35);
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            color: var(--elx-text);
            background: radial-gradient(1200px 600px at 100% -20%, rgba(245,130,32,.12), transparent 55%), radial-gradient(900px 500px at -10% -10%, rgba(13,71,161,.14), transparent 60%), #e9effb;
            background-attachment: fixed;
        }

        /* ===== Shell ===== */
        .elx-shell {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ===== Glass Topbar ===== */
        .elx-topbar-wrap {
            position: sticky;
            top: 0;
            z-index: 1030;
        }

        .elx-topbar-blur {
            background: radial-gradient(900px 420px at 0% 0%, rgba(255,255,255,.22), transparent 60%), linear-gradient(180deg, rgba(10,27,69,.96), rgba(10,25,61,.88));
            border-bottom: 1px solid rgba(255,255,255,.08);
            box-shadow: 0 12px 30px rgba(9,20,48,.38);
        }

        @@supports (backdrop-filter: blur(1px)) {
            .elx-topbar-blur {
                backdrop-filter: blur(14px) saturate(160%);
            }
        }

        .elx-topbar {
            padding-block: 9px;
        }

        .elx-brand-link {
            display: inline-flex;
            align-items: center;
            gap: .6rem;
            color: #fff;
            font-weight: 800;
            letter-spacing: .02em;
            text-decoration: none;
        }

        .elx-brand-logo {
            width: 28px;
            height: 28px;
            border-radius: 10px;
            background: conic-gradient(from 140deg, #1E88E5, #0D47A1, #F58220, #ffd38d, #1E88E5);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 18px rgba(0,0,0,.35);
        }

            .elx-brand-logo::after {
                content: "";
                position: absolute;
                inset: 1px;
                border-radius: inherit;
                background: radial-gradient(circle at 0 0, rgba(255,255,255,.72), transparent 55%), linear-gradient(145deg, rgba(0,0,0,.18), transparent 55%);
                mix-blend-mode: screen;
                opacity: .9;
            }

        .elx-brand-text-main {
            font-size: 1.05rem;
        }

        .elx-brand-text-sub {
            font-size: .72rem;
            text-transform: uppercase;
            letter-spacing: .18em;
            color: rgba(226,232,255,.8);
        }

        /* Nav pills */
        .elx-nav {
            display: flex;
            align-items: center;
            gap: .25rem;
            border-radius: 999px;
            padding: 3px;
            background: radial-gradient(140% 240% at 0 0, rgba(255,255,255,.12), transparent 70%);
        }

        .elx-nav-link {
            border-radius: 999px !important;
            padding: 6px 12px !important;
            font-size: .85rem;
            font-weight: 600;
            color: rgba(226,232,255,.85) !important;
            position: relative;
            text-decoration: none;
        }

            .elx-nav-link.active {
                background: radial-gradient(140% 240% at 0 0, rgba(255,255,255,.92), transparent 80%);
                color: #111827 !important;
                box-shadow: 0 10px 25px rgba(15,35,78,.55);
            }

            .elx-nav-link i {
                font-size: .9rem;
            }

        /* Search */
        .elx-search-wrap {
            display: flex;
            align-items: center;
            gap: .4rem;
            max-width: 260px;
            flex: 1 1 auto;
        }

        .elx-search {
            background: rgba(9,24,63,.92);
            border-radius: 999px;
            border: 1px solid rgba(148,163,210,.55);
            padding: 4px 9px 4px 10px;
            display: flex;
            align-items: center;
            gap: .35rem;
            color: #e5edff;
        }

            .elx-search input {
                border: 0;
                outline: none;
                background: transparent;
                color: inherit;
                font-size: .8rem;
                width: 100%;
            }

                .elx-search input::placeholder {
                    color: #94a3c7;
                }

            /* focus premium */
            .elx-search:focus-within {
                border-color: rgba(147,197,253,.85);
                box-shadow: 0 0 0 4px var(--elx-focus);
            }

        /* Avatar */
        .elx-avatar {
            width: 30px;
            height: 30px;
            border-radius: 999px;
            background: radial-gradient(circle at 0 0, #f97316, #0ea5e9);
            display: grid;
            place-items: center;
            color: #f9fafb;
            font-size: .9rem;
            font-weight: 700;
            border: 1px solid rgba(248,250,252,.4);
            box-shadow: 0 10px 22px rgba(15,23,42,.7);
        }

        /* ===== Main ===== */
        .elx-main {
            flex: 1 0 auto;
            padding: 14px 0 24px;
            min-height: calc(100vh - 160px);
        }

        /* ===== Pagebar ===== */
        .elx-pagebar {
            border-radius: var(--elx-radius-xl);
            border: 1px solid rgba(226,232,240,.75);
            background: linear-gradient(180deg, rgba(255,255,255,.80), rgba(255,255,255,.72));
            box-shadow: var(--elx-shadow-soft);
            padding: 12px 14px;
            margin: 6px 0 14px;
            overflow: hidden;
        }

        @@supports (backdrop-filter: blur(1px)) {
            .elx-pagebar {
                backdrop-filter: blur(14px) saturate(160%);
            }
        }

        .elx-pagebar .ttl {
            font-weight: 900;
            color: #0f172a;
            letter-spacing: .1px;
            font-size: 1.02rem;
            line-height: 1.15;
        }

        .elx-bc {
            margin-top: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            color: #64748b;
            font-weight: 750;
            font-size: .85rem;
        }

            .elx-bc a {
                color: #2563eb;
                text-decoration: none;
                font-weight: 850;
            }

                .elx-bc a:hover {
                    text-decoration: underline;
                }

            .elx-bc .sep {
                opacity: .55;
            }

        /* Dropdown glass */
        .elx-topbar-wrap, .elx-topbar-blur, .elx-topbar, .dropdown, .dropdown-menu {
            position: relative;
            z-index: 9999 !important;
        }

        .dropdown-menu {
            background: rgba(248, 250, 252, 0.82) !important;
            border: 1px solid rgba(255, 255, 255, 0.55) !important;
            box-shadow: 0 18px 35px rgba(0,0,0,0.28);
            border-radius: 16px !important;
            padding: 10px 0 !important;
            margin-top: 10px !important;
            z-index: 20000 !important;
        }

        @@supports (backdrop-filter: blur(1px)) {
            .dropdown-menu {
                backdrop-filter: blur(22px) saturate(180%);
            }
        }

        .dropdown-item {
            font-weight: 650;
            font-size: .92rem;
            padding: 10px 18px !important;
            color: #0f172a !important;
        }

            .dropdown-item:hover {
                background: rgba(255,255,255,0.55) !important;
                border-radius: 10px;
            }

        /* Mobile menu */
        .elx-menu-toggle {
            display: none;
            align-items: center;
            gap: .35rem;
            padding: 4px 9px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,210,.7);
            background: rgba(15,23,42,.5);
            color: #e5edff;
            font-size: .85rem;
            font-weight: 600;
        }

            .elx-menu-toggle i {
                font-size: 1rem;
            }

        @@media (max-width: 991.98px) {
            .elx-nav {
                display: none;
            }

            .elx-menu-toggle {
                display: inline-flex;
            }
        }

        @@media (max-width: 768px) {
            body {
                background: radial-gradient(600px 320px at 100% -20%, rgba(245,130,32,.12), transparent 55%), radial-gradient(600px 320px at -10% -10%, rgba(13,71,161,.12), transparent 60%), #e9effb;
                background-attachment: scroll;
            }
        }

        /* ===== Reduced motion ===== */
        @@media (prefers-reduced-motion: reduce) {
            body {
                background-attachment: scroll;
            }

            .elx-topbar-blur {
                backdrop-filter: none !important;
            }

            .dropdown-menu {
                backdrop-filter: none !important;
            }

            .elx-pagebar {
                backdrop-filter: none !important;
            }
        }

        /* ===== Bell badge ===== */
        .elx-bell {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .elx-bell-badge {
            position: absolute;
            top: -3px;
            right: -3px;
            width: 16px;
            height: 16px;
            border-radius: 999px;
            display: none;
            place-items: center;
            background: #ef4444;
            color: #fff;
            font-size: 11px;
            font-weight: 900;
            border: 2px solid rgba(10,25,61,.95);
            box-shadow: 0 10px 20px rgba(0,0,0,.35);
            line-height: 1;
        }

            .elx-bell-badge.show {
                display: grid;
            }

        /* ===== (NEW) Top loading bar (UI-only) ===== */
        .elx-loadbar {
            position: fixed;
            left: 0;
            top: 0;
            height: 3px;
            width: 0%;
            z-index: 25000;
            background: linear-gradient(90deg, #F58220, #60a5fa);
            box-shadow: 0 10px 18px rgba(0,0,0,.25);
            opacity: 0;
            transition: width .25s ease, opacity .12s ease;
        }

            .elx-loadbar.on {
                opacity: 1;
            }

        @@media (prefers-reduced-motion: reduce) {
            .elx-loadbar {
                transition: none;
            }
        }

        /* ===== Footer dark (GIỮ MÀU CŨ) ===== */
        .elx-footer-dark {
            background: radial-gradient(900px 380px at 85% -15%, rgba(39,195,243,.08), transparent 45%), radial-gradient(800px 380px at 5% 0%, rgba(245,130,32,.08), transparent 55%), var(--elx-navy-900);
            color: #eaf0ff;
            border-top: 1px solid var(--elx-stroke);
            position: relative;
            margin-top: 8px;
        }

            .elx-footer-dark::before,
            .elx-footer-dark::after {
                content: "";
                position: absolute;
                pointer-events: none;
                opacity: .22;
                background: radial-gradient(2px 2px at 10% 30%, #7cc6ff 60%, transparent 61%), radial-gradient(2px 2px at 25% 70%, #7cc6ff 60%, transparent 61%), radial-gradient(2px 2px at 60% 20%, #7cc6ff 60%, transparent 61%), radial-gradient(2px 2px at 85% 45%, #7cc6ff 60%, transparent 61%), radial-gradient(2px 2px at 70% 80%, #7cc6ff 60%, transparent 61%);
            }

            .elx-footer-dark::before {
                inset: 0 0 60% 0;
            }

            .elx-footer-dark::after {
                inset: 40% 0 0 0;
            }

            .elx-footer-dark h6 {
                font-weight: 800;
                color: #fff;
                margin-bottom: .5rem;
            }

            .elx-footer-dark p, .elx-footer-dark span, .elx-footer-dark li, .elx-footer-dark a {
                color: #cbd5e1;
                font-size: .86rem;
            }

                .elx-footer-dark a:hover {
                    color: #fff;
                    text-decoration: underline;
                }

        .elx-footer-logo {
            width: 66px;
            height: 66px;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,.08);
            background: radial-gradient(circle at 0 0, rgba(255,255,255,.12), transparent 60%);
            display: grid;
            place-items: center;
        }

            .elx-footer-logo img {
                border-radius: 12px;
                box-shadow: 0 10px 28px rgba(0,0,0,.55);
                transition: transform .2s ease, box-shadow .2s ease;
            }

                .elx-footer-logo img:hover {
                    transform: scale(1.05);
                    box-shadow: 0 6px 18px rgba(0,0,0,.5);
                }

        .elx-footer-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(15,23,42,.9);
            color: #bfdbfe;
            border: 1px solid rgba(148,163,184,.6);
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 800;
            font-size: .9rem;
        }

        .elx-footer-list {
            list-style: none;
            padding-left: 0;
        }

            .elx-footer-list li {
                margin: .35rem 0;
                display: flex;
                gap: .6rem;
                align-items: flex-start;
            }

            .elx-footer-list i {
                width: 22px;
                height: 22px;
                display: grid;
                place-items: center;
                border-radius: 7px;
                background: rgba(15,23,42,.9);
                color: #cbd5f5;
                font-size: .8rem;
                border: 1px solid rgba(148,163,184,.55);
            }

        .elx-footer-partners {
            background: rgba(15,23,42,.88);
            border-radius: 16px;
            padding: 10px;
            border: 1px solid rgba(148,163,184,.55);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .elx-partner-pill {
            background: rgba(15,23,42,.96);
            border-radius: 999px;
            padding: 7px 11px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(148,163,184,.6);
        }

            .elx-partner-pill img {
                width: 22px;
                height: 22px;
                border-radius: 999px;
                object-fit: cover;
                background: #020617;
            }

            .elx-partner-pill span {
                color: #e5e7eb;
                font-weight: 600;
                font-size: .8rem;
            }

        .elx-footer-bottom {
            background: #020617;
            border-top: 1px solid rgba(15,23,42,1);
            color: #9ca3af;
            font-size: .82rem;
        }

            .elx-footer-bottom a {
                color: #93c5fd;
                text-decoration: none;
                font-weight: 700;
            }

                .elx-footer-bottom a:hover {
                    text-decoration: underline;
                }

        /* ===== (NEW) Quick Action FAB (UI-only) ===== */
        .elx-fab {
            position: fixed;
            right: 18px;
            bottom: 18px;
            z-index: 24000;
            display: grid;
            gap: 10px;
            pointer-events: none;
        }

            .elx-fab .btn {
                pointer-events: auto;
                border-radius: 999px;
                box-shadow: 0 18px 38px rgba(0,0,0,.22);
                font-weight: 850;
            }

            .elx-fab .fab-main {
                width: 56px;
                height: 56px;
                display: grid;
                place-items: center;
                background: linear-gradient(180deg, #ffb066, var(--elx-orange));
                border: 1px solid rgba(255,255,255,.35);
                color: #fff;
            }

            .elx-fab .fab-item {
                display: none;
                align-items: center;
                gap: 10px;
                background: rgba(17,24,39,.92);
                border: 1px solid rgba(255,255,255,.12);
                color: #fff;
                padding: 10px 12px;
                backdrop-filter: blur(10px);
            }

            .elx-fab.open .fab-item {
                display: inline-flex;
            }

            .elx-fab .fab-item i {
                font-size: 1rem;
                opacity: .95;
            }

            .elx-fab .fab-item span {
                font-size: .86rem;
            }

        @@media (max-width: 768px) {
            .elx-fab {
                right: 14px;
                bottom: 14px;
            }
        }

        @@media (prefers-reduced-motion: reduce) {
            .elx-fab .btn {
                transition: none;
            }
        }
    </style>
</head>

<body>
    @{
        // ===== detect admin/user once =====
        bool isAdmin = false;
        string brandTitle = "Elitech System";

        if (User?.Identity?.IsAuthenticated == true)
        {
            isAdmin = User.IsInRole("Admin");
            brandTitle = isAdmin ? "Elitech Admin" : "Elitech User";
        }

        // ✅ GIỮ FOOTER MÀU CŨ: luôn dark
        var footerClass = "elx-footer-dark";

        // Breadcrumb + page title
        var pageTitle = (ViewData["Title"]?.ToString() ?? "").Trim();
        var ctrl = (ViewContext.RouteData.Values["controller"]?.ToString() ?? "").Trim();
        var act = (ViewContext.RouteData.Values["action"]?.ToString() ?? "").Trim();
        var showPageBar = !string.IsNullOrWhiteSpace(pageTitle);

        string ctrlLabel = ctrl switch
        {
            "Admin" => "Admin",
            "User" => "User",
            "ElitechRealtime" => "Realtime",
            "ElitechHistoryPage" => "History",
            _ => ctrl
        };
        string actLabel = act switch
        {
            "Index" => "Home",
            "AssignDevices" => "Assign Devices",
            "MyDevices" => "My Devices",
            _ => act
        };

        // FAB target links (UI-only)
        var linkDashboard = isAdmin ? Url.Action("Index", "Admin") : Url.Action("Index", "User");
        var linkRealtime = Url.Action("Index", "ElitechRealtime");
        var linkHistory = Url.Action("Index", "ElitechHistoryPage");
        var linkMyDevices = Url.Action("MyDevices", "User");
    }

    <div class="elx-loadbar" id="elxLoadbar"></div>

    <div class="elx-shell">

        <!-- ===== Topbar ===== -->
        <div class="elx-topbar-wrap">
            <div class="elx-topbar-blur">
                <div class="container-xl">
                    <div class="elx-topbar d-flex align-items-center justify-content-between gap-3">

                        @* BRAND LINK: giữ đúng logic route *@
                        @if (User?.Identity?.IsAuthenticated == true)
                        {
                            if (isAdmin)
                            {
                                <a class="elx-brand-link" asp-controller="Admin" asp-action="Index">
                                    <span class="elx-brand-logo"></span>
                                    <span class="d-flex flex-column">
                                        <span class="elx-brand-text-main">@brandTitle</span>
                                        <span class="elx-brand-text-sub">Device • Monitoring • Suite</span>
                                    </span>
                                </a>
                            }
                            else
                            {
                                <a class="elx-brand-link" asp-controller="User" asp-action="Index">
                                    <span class="elx-brand-logo"></span>
                                    <span class="d-flex flex-column">
                                        <span class="elx-brand-text-main">@brandTitle</span>
                                        <span class="elx-brand-text-sub">Device • Monitoring • Suite</span>
                                    </span>
                                </a>
                            }
                        }
                        else
                        {
                            <a class="elx-brand-link" asp-controller="Home" asp-action="Index">
                                <span class="elx-brand-logo"></span>
                                <span class="d-flex flex-column">
                                    <span class="elx-brand-text-main">@brandTitle</span>
                                    <span class="elx-brand-text-sub">Device • Monitoring • Suite</span>
                                </span>
                            </a>
                        }

                        @if (User?.Identity?.IsAuthenticated == true)
                        {
                            <!-- Nút menu mobile -->
                            <button class="elx-menu-toggle d-md-none ms-auto"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#elxNavMobile"
                                    aria-controls="elxNavMobile"
                                    aria-expanded="false"
                                    aria-label="Toggle navigation">
                                <i class="bi bi-list"></i> Menu
                            </button>

                            <!-- Nav center (desktop) -->
                            <nav class="elx-nav d-none d-md-flex ms-3">
                                @if (isAdmin)
                                {
                                    <a class="elx-nav-link @(ViewContext.RouteData.Values["controller"]?.ToString()=="Admin"?"active":"")"
                                       asp-controller="Admin" asp-action="Index">
                                        <i class="bi bi-speedometer2 me-1"></i>Dashboard
                                    </a>

                                    <a class="elx-nav-link @(ViewContext.RouteData.Values["controller"]?.ToString()=="ElitechDevicePage"?"active":"")"
                                       asp-controller="ElitechDevicePage" asp-action="Index">
                                        <i class="bi bi-cpu me-1"></i>Devices
                                    </a>


                                    <a class="elx-nav-link @(ViewContext.RouteData.Values["controller"]?.ToString()=="ElitechRealtime"?"active":"")"
                                       asp-controller="ElitechRealtime" asp-action="Index">
                                        <i class="bi bi-bell me-1"></i>Realtime
                                    </a>

                                    <a class="elx-nav-link @(ViewContext.RouteData.Values["controller"]?.ToString()=="Admin" && ViewContext.RouteData.Values["action"]?.ToString()=="AssignDevices"?"active":"")"
                                       asp-controller="Admin" asp-action="AssignDevices">
                                        <i class="bi bi-graph-up me-1"></i>AssignDevices
                                    </a>

                                    <a class="elx-nav-link @(ViewContext.RouteData.Values["controller"]?.ToString()=="ElitechHistoryPage"?"active":"")"
                                       asp-controller="ElitechHistoryPage" asp-action="Index">
                                        <i class="bi bi-activity me-1"></i>History Chart
                                    </a>
                                }
                                else
                                {
                                    <a class="elx-nav-link @(ViewContext.RouteData.Values["controller"]?.ToString()=="User"?"active":"")"
                                       asp-controller="User" asp-action="Index">
                                        <i class="bi bi-house-door me-1"></i>Dashboard
                                    </a>

                                    <a class="elx-nav-link @(ViewContext.RouteData.Values["controller"]?.ToString()=="ElitechHistoryPage"?"active":"")"
                                       asp-controller="ElitechHistoryPage" asp-action="Index">
                                        <i class="bi bi-activity me-1"></i>Biểu đồ
                                    </a>

                                    <a class="elx-nav-link @(ViewContext.RouteData.Values["action"]?.ToString()=="MyDevices"?"active":"")"
                                       asp-controller="User" asp-action="MyDevices">
                                        <i class="bi bi-cpu me-1"></i>Thiết bị của tôi
                                    </a>
                                }
                            </nav>

                            <!-- SEARCH + USER DROPDOWN -->
                            <div class="d-flex align-items-center gap-3 ms-auto">

                                <div class="elx-search-wrap d-none d-sm-flex">
                                    <div class="elx-search w-100">
                                        <i class="bi bi-search"></i>
                                        <input id="elxSearchInput" type="search" placeholder="Search devices…" />
                                        <span class="small text-uppercase" style="font-size:.65rem;opacity:.7;">Ctrl+K</span>
                                    </div>
                                </div>

                                <ul class="navbar-nav ms-auto flex-row align-items-center">
                                    <li class="nav-item me-2">
                                        <a class="nav-link text-light elx-bell" href="#" aria-label="Notifications">
                                            <i class="bi bi-bell-fill"></i>
                                            <span id="elxBellBadge" class="elx-bell-badge" title="Có cảnh báo mới">•</span>
                                        </a>
                                    </li>

                                    <li class="nav-item dropdown">
                                        <button class="btn btn-sm btn-outline-light border-0 d-flex align-items-center gap-2 px-2 py-1"
                                                type="button" data-bs-toggle="dropdown">
                                            <span class="elx-avatar"><i class="bi bi-person-fill"></i></span>
                                            <span class="d-none d-sm-flex flex-column align-items-start">
                                                <span style="font-size:.8rem;font-weight:600;">@User.Identity?.Name</span>
                                                <span class="text-muted" style="font-size:.7rem;">
                                                    @(isAdmin ? "Elitech Admin" : "Elitech User")
                                                </span>
                                            </span>
                                            <i class="bi bi-chevron-down small"></i>
                                        </button>

                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" href="/Profile">
                                                    <i class="bi bi-person me-2"></i> Profile
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="/Settings">
                                                    <i class="bi bi-gear me-2"></i> Settings
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider" /></li>
                                            <li>
                                                <form asp-controller="Login" asp-action="Logout" method="post" class="m-0">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="dropdown-item text-danger">
                                                        <i class="bi bi-box-arrow-right me-2"></i> Logout
                                                    </button>
                                                </form>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>

                            </div>
                        }
                        else
                        {
                            <div class="ms-auto">
                                <a asp-controller="Login" asp-action="Index"
                                   class="btn btn-sm btn-light fw-bold px-3 py-1 rounded-pill">
                                    <i class="bi bi-box-arrow-in-right me-1"></i> Đăng nhập
                                </a>
                            </div>
                        }
                    </div>

                    <!-- Mobile nav -->
                    <div class="collapse pb-2" id="elxNavMobile">
                        <nav class="nav flex-column gap-1">
                            @if (User?.Identity?.IsAuthenticated == true)
                            {
                                if (User.IsInRole("Admin"))
                                {
                                    <a class="nav-link text-light @(ViewContext.RouteData.Values["controller"]?.ToString()=="Admin"?"fw-bold":"")"
                                       asp-controller="Admin" asp-action="Index"><i class="bi bi-speedometer2 me-1"></i> Dashboard</a>

                                    <a class="nav-link text-light @(ViewContext.RouteData.Values["controller"]?.ToString()=="ElitechHistoryPage"?"fw-bold":"")"
                                       asp-controller="ElitechHistoryPage" asp-action="Index"><i class="bi bi-hdd-rack me-1"></i> History</a>

                                    <a class="nav-link text-light @(ViewContext.RouteData.Values["controller"]?.ToString()=="ElitechRealtime"?"fw-bold":"")"
                                       asp-controller="ElitechRealtime" asp-action="Index"><i class="bi bi-bell me-1"></i> Realtime</a>

                                    <a class="nav-link text-light @(ViewContext.RouteData.Values["action"]?.ToString()=="AssignDevices"?"fw-bold":"")"
                                       asp-controller="Admin" asp-action="AssignDevices"><i class="bi bi-graph-up me-1"></i> AssignDevices</a>
                                }
                                else
                                {
                                    <a class="nav-link text-light @(ViewContext.RouteData.Values["controller"]?.ToString()=="User"?"fw-bold":"")"
                                       asp-controller="User" asp-action="Index"><i class="bi bi-house-door me-1"></i> Dashboard</a>

                                    <a class="nav-link text-light @(ViewContext.RouteData.Values["controller"]?.ToString()=="ElitechHistoryPage"?"fw-bold":"")"
                                       asp-controller="ElitechHistoryPage" asp-action="Index"><i class="bi bi-activity me-1"></i> Biểu đồ</a>

                                    <a class="nav-link text-light @(ViewContext.RouteData.Values["action"]?.ToString()=="MyDevices"?"fw-bold":"")"
                                       asp-controller="User" asp-action="MyDevices"><i class="bi bi-cpu me-1"></i> Thiết bị của tôi</a>
                                }
                            }
                        </nav>
                    </div>

                </div>
            </div>
        </div>

        <!-- ===== Main ===== -->
        <main class="elx-main">
            <div class="container-xl">


                @RenderBody()
            </div>
        </main>

        <!-- ===== Footer (dark, màu cũ) ===== -->
        <footer class="@footerClass pt-5 mt-auto">
            <div class="container-xl position-relative">
                <div class="row g-4 align-items-start">
                    <div class="col-lg-4">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <div class="elx-footer-logo">
                                <img src="~/Pictures/logo.png" class="img-fluid" alt="SmartTech logo" />
                            </div>
                            <span class="elx-footer-badge"><i class="bi bi-cpu"></i> SmartTech • AI Lab</span>
                        </div>
                        <h6>GIỚI THIỆU</h6>
                        <p><strong>SMARTTECH</strong> – cung cấp giải pháp công nghệ thông minh cho doanh nghiệp.</p>
                        <ul class="elx-footer-list">
                            <li><i class="bi bi-geo-alt"></i><span>200/1 Phan Đăng Lưu, Q.Phú Nhuận, HCMC</span></li>
                            <li><i class="bi bi-telephone"></i><span>028-7300-3603 • 1900-633-603</span></li>
                            <li><i class="bi bi-envelope"></i><span>sales@smarttechco.com.vn</span></li>
                            <li><i class="bi bi-check2-all"></i><span>Giải pháp cảm biến • kho lạnh • chuẩn audit</span></li>
                        </ul>
                    </div>

                    <div class="col-lg-4">
                        <h6>SMARTTECH VIETNAM</h6>
                        <div class="ratio ratio-16x9 mb-2">
                            <iframe src="https://www.youtube.com/embed/Jm8bJoOCHlM"
                                    title="SmartTech Video"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                    allowfullscreen></iframe>
                        </div>
                        <div>Hotline: <strong>0903.444.073</strong> • <strong>0988.527.375</strong></div>
                    </div>

                    <div class="col-md-4 col-lg-2">
                        <h6>LIÊN KẾT NHANH</h6>
                        <ul class="elx-footer-list">
                            <li><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
                            <li><a href="#">Về SmartTech</a></li>
                            <li><a href="#">Sản phẩm</a></li>
                            <li><a href="#">Liên hệ</a></li>
                            <li><a asp-controller="Home" asp-action="Privacy">Chính sách bảo mật</a></li>
                        </ul>
                    </div>

                    <div class="col-md-8 col-lg-2">
                        <h6>ĐỐI TÁC CHIẾN LƯỢC</h6>
                        <div class="elx-footer-partners">
                            <div class="elx-partner-pill">
                                <img src="https://via.placeholder.com/26" alt="LogTag" /><span>LogTag Online</span>
                            </div>
                            <div class="elx-partner-pill">
                                <img src="https://via.placeholder.com/26" alt="SmartTech" /><span>SmartTech</span>
                            </div>
                            <div class="elx-partner-pill">
                                <img src="https://via.placeholder.com/26" alt="LogTag Cloud" /><span>LogTag Cloud</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="elx-footer-bottom py-3 mt-4">
                <div class="container-xl d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <div>© @DateTime.UtcNow.Year SmartTech • All rights reserved</div>
                    <div class="d-flex gap-3">
                        <a asp-controller="Home" asp-action="Privacy">Privacy</a>
                        <a href="https://www.elitechus.com/" target="_blank" rel="noopener">Elitech Website</a>
                    </div>
                </div>
            </div>
        </footer>

        <!-- ===== Quick Action FAB (UI-only) ===== -->
        @if (User?.Identity?.IsAuthenticated == true)
        {
            <div class="elx-fab" id="elxFab">
                <a class="btn fab-item" href="@linkDashboard"><i class="bi bi-house-door"></i><span>Dashboard</span></a>
                <a class="btn fab-item" href="@linkRealtime"><i class="bi bi-bell"></i><span>Realtime</span></a>
                <a class="btn fab-item" href="@linkHistory"><i class="bi bi-activity"></i><span>History</span></a>

                @if (!isAdmin)
                {
                    <a class="btn fab-item" href="@linkMyDevices"><i class="bi bi-cpu"></i><span>Thiết bị của tôi</span></a>
                }

                <button type="button" class="btn fab-main" id="elxFabBtn" aria-label="Quick actions">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
        }

        <div id="elitechToastHost" style="position:fixed;right:18px;top:18px;z-index:4000;max-width:420px"></div>
        <audio id="alarmAudio" preload="auto">
            <source src="/sounds/alarm.mp3" type="audio/mpeg" />
        </audio>

        @* =========================
           ✅ SCRIPT QUAN TRỌNG — GIỮ NGUYÊN 100%
           ========================= *@
        <script>
            (function () {
              const host = document.getElementById('elitechToastHost');
              if (!host) return;

              const LS_KEY = 'elitech_seen_alert_ids_v1';

              function loadSeen() {
                try {
                  const raw = localStorage.getItem(LS_KEY);
                  const arr = raw ? JSON.parse(raw) : [];
                  return new Set(Array.isArray(arr) ? arr.filter(x => typeof x === 'string') : []);
                } catch {
                  return new Set();
                }
              }

              function saveSeen(set) {
                try {
                  const arr = Array.from(set);
                  const trimmed = arr.length > 300 ? arr.slice(arr.length - 300) : arr;
                  localStorage.setItem(LS_KEY, JSON.stringify(trimmed));
                } catch { }
              }

              const seen = loadSeen();

              const AUDIO_KEY = 'elitech_audio_unlocked_v1';
              let audioUnlocked = false;

              const audioHigh = new Audio('/sounds/alarm.mp3');
              const audioWarn = new Audio('/sounds/alarm.mp3');

              audioHigh.preload = 'auto';
              audioWarn.preload = 'auto';
              audioHigh.loop = true;
              audioWarn.loop = true;
              audioHigh.volume = 0.85;
              audioWarn.volume = 0.60;

              let activeHighCount = 0;
              let activeWarnCount = 0;
              let pendingLevel = null;

              try {
                if (localStorage.getItem(AUDIO_KEY) === '1') audioUnlocked = true;
              } catch { }

              function normalizeLevel(level) {
                const lv = String(level || '').toLowerCase();
                if (lv === 'warn' || lv === 'warning') return 'warn';
                return 'high';
              }

              function stopAllAudio() {
                try { audioHigh.pause(); audioHigh.currentTime = 0; } catch { }
                try { audioWarn.pause(); audioWarn.currentTime = 0; } catch { }
              }

              function syncAudio() {
                const needHigh = activeHighCount > 0;
                const needWarn = !needHigh && activeWarnCount > 0;

                if (!needHigh && !needWarn) {
                  stopAllAudio();
                  return;
                }

                if (needHigh) {
                  if (!audioWarn.paused) { audioWarn.pause(); audioWarn.currentTime = 0; }
                  if (audioHigh.paused) {
                    audioHigh.currentTime = 0;
                    audioHigh.play().catch(err => console.warn('⛔ play HIGH blocked:', err));
                  }
                  return;
                }

                if (!audioHigh.paused) { audioHigh.pause(); audioHigh.currentTime = 0; }
                if (audioWarn.paused) {
                  audioWarn.currentTime = 0;
                  audioWarn.play().catch(err => console.warn('⛔ play WARN blocked:', err));
                }
              }

              async function unlockAudio() {
                if (audioUnlocked) return;

                try {
                  await audioHigh.play();
                  audioHigh.pause(); audioHigh.currentTime = 0;

                  await audioWarn.play();
                  audioWarn.pause(); audioWarn.currentTime = 0;

                  audioUnlocked = true;
                  try { localStorage.setItem(AUDIO_KEY, '1'); } catch { }

                  if (pendingLevel) {
                    if (pendingLevel === 'warn') activeWarnCount++;
                    else activeHighCount++;
                    pendingLevel = null;
                    syncAudio();
                  }

                  console.log('✅ Audio unlocked');
                } catch (e) {
                  audioUnlocked = false;
                  console.warn('❌ Unlock failed:', e);
                }
              }

              window.addEventListener('click', unlockAudio, { once: true });
              window.addEventListener('keydown', unlockAudio, { once: true });

              function beginSound(level) {
                const lv = normalizeLevel(level);

                if (!audioUnlocked) {
                  pendingLevel = lv;
                  console.log('🔇 audio locked → pendingLevel=', pendingLevel);
                  return;
                }

                if (lv === 'warn') activeWarnCount++;
                else activeHighCount++;

                syncAudio();
              }

              function endSound(level) {
                const lv = normalizeLevel(level);

                if (lv === 'warn') activeWarnCount = Math.max(0, activeWarnCount - 1);
                else activeHighCount = Math.max(0, activeHighCount - 1);

                syncAudio();
              }

              function stableKey(a) {
                const raw = a?.id ?? a?._id ?? a?.Id ?? a?.ID;
                if (typeof raw === 'string' && raw.trim()) return raw.trim();

                const dg = (a?.deviceGuid ?? a?.DeviceGuid ?? '').toString().trim();
                const ts = (a?.occurredAtUtc ?? a?.OccurredAtUtc ?? a?.ts ?? a?.alarmTimeStamp ?? '').toString().trim();
                return (dg && ts) ? (dg + '|' + ts) : (dg || ts || JSON.stringify(a));
              }

              function toastAlert(a) {
                const key = stableKey(a);

                if (seen.has(key)) return;
                seen.add(key);
                saveSeen(seen);

                const dev = (a?.deviceName ?? a?.DeviceName ?? 'Device').toString();
                const reasons = (a?.reasons ?? a?.Reasons ?? a?.message ?? a?.Message ?? 'ALARM').toString();
                const whenRaw = a?.occurredAtUtc ?? a?.OccurredAtUtc ?? a?.ts;
                const when = whenRaw ? new Date(whenRaw).toLocaleString() : '';

                const level = (a?.level ?? a?.Level ?? 'high');

                const el = document.createElement('div');
                el.setAttribute('data-level', normalizeLevel(level));
                el.setAttribute('data-alert-key', key);

                el.style.cssText = `
                  background:#111827;color:#fff;border-radius:14px;padding:12px 14px;margin-bottom:10px;
                  box-shadow:0 18px 40px rgba(0,0,0,.18);cursor:pointer;border:1px solid rgba(255,255,255,.1)
                `;
                el.innerHTML = `
                  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
                    <div style="font-weight:900">⚠️ ${dev}</div>
                    <div style="opacity:.75;font-size:12px">${when}</div>
                  </div>
                  <div style="opacity:.9;margin-top:6px;font-size:13px">${reasons}</div>
                  <div style="opacity:.75;margin-top:6px;font-size:12px">Bấm để xem chi tiết</div>
                `;

                el.addEventListener('click', async () => {
                  try {
                    const oid = a?.id ?? a?._id ?? a?.Id ?? a?.ID;
                    if (typeof oid === 'string' && oid.trim()) {
                      await fetch('/api/elitech/alerts/mark-read?id=' + encodeURIComponent(oid.trim()), { method: 'POST' });
                    }
                  } catch { }

                  window.location.href = '/realtime';
                });

                host.appendChild(el);

                beginSound(level);

                setTimeout(() => { el.style.opacity = '0'; el.style.transition = 'opacity .25s'; }, 9000);
                setTimeout(() => {
                  endSound(level);
                  el.remove();
                }, 9400);
              }

              async function pollUnread() {
                try {
                  const res = await fetch('/api/elitech/alerts/unread?take=5', { cache: 'no-store' });
                  if (!res.ok) return;
                  const json = await res.json();
                  const list = json?.data ?? [];
                  list.reverse().forEach(toastAlert);
                } catch { }
              }

              pollUnread();
              setInterval(pollUnread, 15000);
            })();
        </script>

    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    @* =========================
       UI-only enhancements (không đụng script quan trọng)
       - Ctrl+K focus search
       - Bell badge mirror from toast host
       - Top loading bar when navigating internal links
       - FAB quick actions
       ========================= *@
    <script>
        (function elxUiEnhance() {
            // Ctrl+K focus search
            const input = document.getElementById('elxSearchInput');
            window.addEventListener('keydown', (e) => {
                const key = (e.key || '').toLowerCase();
                if ((e.ctrlKey || e.metaKey) && key === 'k') {
                    if (!input) return;
                    e.preventDefault();
                    input.focus();
                    input.select?.();
                }
                if (key === 'escape' && document.activeElement === input) {
                    input.blur();
                }
            }, { passive: false });

            // Bell badge: show dot when has toast in #elitechToastHost
            const host = document.getElementById('elitechToastHost');
            const badge = document.getElementById('elxBellBadge');
            if (host && badge) {
                const sync = () => {
                    const has = host.children && host.children.length > 0;
                    badge.classList.toggle('show', !!has);
                };
                sync();
                const obs = new MutationObserver(sync);
                obs.observe(host, { childList: true, subtree: false });
            }

            // Top loading bar for internal navigation (lightweight)
            const bar = document.getElementById('elxLoadbar');
            let timer = null;

            function barStart() {
                if (!bar) return;
                bar.classList.add('on');
                bar.style.width = '20%';
                clearTimeout(timer);
                timer = setTimeout(() => { bar.style.width = '68%'; }, 180);
            }

            function barDone() {
                if (!bar) return;
                bar.style.width = '100%';
                clearTimeout(timer);
                timer = setTimeout(() => {
                    bar.classList.remove('on');
                    bar.style.width = '0%';
                }, 240);
            }

            // click on internal links
            document.addEventListener('click', (e) => {
                const a = e.target && e.target.closest ? e.target.closest('a') : null;
                if (!a) return;
                const href = a.getAttribute('href') || '';
                if (!href || href.startsWith('#')) return;
                if (a.target && a.target === '_blank') return;
                // internal only
                const isExternal = /^https?:\/\//i.test(href);
                if (isExternal) return;

                barStart();
                // if navigation is canceled, still auto-clear
                setTimeout(barDone, 1800);
            }, { passive: true });

            window.addEventListener('pageshow', barDone);

            // FAB toggle
            const fab = document.getElementById('elxFab');
            const fabBtn = document.getElementById('elxFabBtn');
            if (fab && fabBtn) {
                fabBtn.addEventListener('click', () => {
                    fab.classList.toggle('open');
                });

                // click outside to close
                document.addEventListener('click', (e) => {
                    if (!fab.classList.contains('open')) return;
                    if (fab.contains(e.target)) return;
                    fab.classList.remove('open');
                });
            }
        })();
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
